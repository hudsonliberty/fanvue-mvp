<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MidKnight VIP Services â€” MVP</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0b10; color:#e9e9f1; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 22px 14px 64px; }
    .top { display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom: 14px; }
    .brand { display:flex; align-items:center; gap:12px; }
    .logo { width:44px; height:44px; border-radius:12px; background:linear-gradient(135deg,#ff2d8d,#7c3aed); display:grid; place-items:center; font-weight:800; color:#fff; font-size:18px; }
    .muted { color:#a7a7bd; font-size: 13px; }
    .pill { padding:6px 10px; border:1px solid #26263a; border-radius:999px; background:#12121a; font-size:12px; color:#cfcfe5; }
    .grid { display:grid; gap:14px; grid-template-columns: 1.1fr 0.9fr; }
    @media (max-width: 980px){ .grid { grid-template-columns: 1fr; } }
    .card { border:1px solid #232338; background:#10101a; border-radius:16px; padding:16px; display:flex; flex-direction:column; gap:12px; }
    .card h2 { margin: 0; font-size: 13px; letter-spacing: .2px; text-transform:uppercase; color:#7c7c98; font-weight:800; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn { cursor:pointer; border:1px solid #2a2a43; background:#171724; color:#e9e9f1; border-radius:10px; padding:9px 12px; font-weight:700; font-size:13px; }
    .btn.primary { border-color:#6d28d9; background:linear-gradient(135deg,#6d28d9,#ff2d8d); color:white; }
    .btn.danger { border-color:#b91c1c; background:#1a0f13; color:#ffd7d7; }
    .table { width:100%; border-collapse: collapse; }
    .table th, .table td { border-bottom:1px solid #202033; padding:10px 8px; text-align:left; font-size:13px; }
    .table th { color:#bdbde0; font-weight:900; font-size:11px; text-transform: uppercase; }
    .status { display:flex; align-items:center; gap:8px; }
    .dot { width:8px; height:8px; border-radius:999px; background:#444; }
    .dot.ok { background:#22c55e; }
    .dot.warn { background:#f59e0b; }
    .mono { font-family: ui-monospace, monospace; font-size:12px; }
    .textarea { width:100%; min-height: 160px; border-radius: 12px; border:1px solid #26263a; background:#0c0c13; color:#e9e9f1; padding:12px; font-family: ui-monospace, monospace; font-size:12px; }
    .hr { height:1px; background:#1f1f31; margin: 4px 0; border:0; width:100%; }

    .profileBar { display:flex; align-items:center; gap:10px; margin-top:10px; }
    .avatar { width:44px; height:44px; border-radius:50%; object-fit:cover; background:#2a2a43; border:1px solid #2a2a43; }
    .who { display:flex; flex-direction:column; gap:2px; }
    .who b { font-size:14px; }
    .who span { color:#a7a7bd; font-size:12px; }
    .rightTop { display:flex; flex-direction:column; align-items:flex-end; gap:10px; }

    .mini { font-size: 12px; color:#a7a7bd; }
    .kv { display:flex; gap:10px; flex-wrap:wrap; }
    .kv .box { border:1px solid #232338; background:#0c0c13; border-radius:12px; padding:10px; min-width: 180px; }
    .kv .box .k { color:#a7a7bd; font-size:11px; text-transform:uppercase; font-weight:900; letter-spacing:.4px; }
    .kv .box .v { margin-top:6px; font-weight:800; }
  </style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <div>
      <div class="brand">
        <div class="logo">MV</div>
        <div>
          <div style="font-weight:950;font-size:18px;">MidKnight VIP Services</div>
          <div class="muted">Phase 1: Live Fanvue Control</div>
        </div>
      </div>

      <div id="creatorRow" class="profileBar" style="display:none;">
        <img id="creatorAvatar" class="avatar" alt="creator" />
        <div class="who">
          <b id="creatorName"></b>
          <span id="creatorHandle"></span>
        </div>
      </div>
    </div>

    <div class="rightTop">
      <span class="pill">MVP LIVE</span>
      <div class="row">
        <button class="btn primary" id="btnLogin">Start OAuth Login</button>
        <button class="btn danger" id="btnLogout" style="display:none;">Logout</button>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Operations Console</h2>

      <div class="row">
        <button class="btn primary" id="btnEnable">Enable Auto-Reply</button>
        <button class="btn danger" id="btnKill">Kill Switch</button>
        <button class="btn" id="btnRefresh">Refresh Status</button>
      </div>

      <hr class="hr"/>

      <table class="table">
        <tr><th>Component</th><th>Status</th></tr>
        <tr>
          <td>Auth Token</td>
          <td class="status"><span id="dotToken" class="dot warn"></span><b id="txtToken">Missing</b></td>
        </tr>
        <tr>
          <td>Webhook</td>
          <td class="status"><span id="dotWebhook" class="dot warn"></span><b id="txtWebhook">Idle</b></td>
        </tr>
        <tr>
          <td>Reply Engine</td>
          <td class="status"><span id="dotReply" class="dot"></span><b id="txtReply">Standby</b></td>
        </tr>
      </table>

      <hr class="hr"/>

      <h2>Latest Webhook</h2>

      <div class="kv">
        <div class="box">
          <div class="k">Sender</div>
          <div class="v" id="wbSender">â€”</div>
          <div class="mini" id="wbHandle"></div>
        </div>
        <div class="box">
          <div class="k">Message UUID</div>
          <div class="v mono" id="wbMsg">â€”</div>
        </div>
        <div class="box">
          <div class="k">Received</div>
          <div class="v mono" id="wbTime">â€”</div>
        </div>
      </div>

      <textarea class="textarea" id="payloadBox" readonly>// No webhook received yet</textarea>
    </div>

    <div class="card">
      <h2>Reply Generator</h2>

      <div class="row">
        <button class="btn" data-persona="sweet">Sweet</button>
        <button class="btn" data-persona="flirty">Flirty</button>
        <button class="btn" data-persona="dominant">Dominant</button>
      </div>

      <div class="row">
        <button class="btn" data-goal="sub">Subscription</button>
        <button class="btn" data-goal="tip">Tip</button>
        <button class="btn" data-goal="ppv">PPV</button>
      </div>

      <div class="row">
        <button class="btn primary" id="btnGen">Generate Reply</button>
      </div>

      <hr class="hr"/>

      <h2>Generated Reply</h2>
      <textarea class="textarea" id="replyBox" readonly>// Select persona and goal, then Generate</textarea>

      <h2>Activity Log</h2>
      <div id="activity" class="mono" style="max-height:170px; overflow-y:auto;"></div>
    </div>
  </div>

</div>

<script>
const logBox = document.getElementById("activity");

const dotToken = document.getElementById("dotToken");
const txtToken = document.getElementById("txtToken");

const dotWebhook = document.getElementById("dotWebhook");
const txtWebhook = document.getElementById("txtWebhook");

const dotReply = document.getElementById("dotReply");
const txtReply = document.getElementById("txtReply");

const payloadBox = document.getElementById("payloadBox");

const creatorRow = document.getElementById("creatorRow");
const creatorAvatar = document.getElementById("creatorAvatar");
const creatorName = document.getElementById("creatorName");
const creatorHandle = document.getElementById("creatorHandle");

const btnLogin = document.getElementById("btnLogin");
const btnLogout = document.getElementById("btnLogout");

const wbSender = document.getElementById("wbSender");
const wbHandle = document.getElementById("wbHandle");
const wbMsg = document.getElementById("wbMsg");
const wbTime = document.getElementById("wbTime");

const replyBox = document.getElementById("replyBox");

let state = {
  authed: false,
  replies: false,
  persona: "flirty",
  goal: "ppv",
  lastWebhookAt: 0
};

function log(msg){
  const now = new Date().toLocaleTimeString();
  logBox.innerHTML = `<div>[${now}] ${msg}</div>` + logBox.innerHTML;
}

function setDot(dotEl, mode){
  dotEl.className = "dot" + (mode === "ok" ? " ok" : mode === "warn" ? " warn" : "");
}

function updateUI(){
  if(state.authed){
    setDot(dotToken, "ok");
    txtToken.textContent = "Active";
    btnLogin.style.display = "none";
    btnLogout.style.display = "inline-block";
  } else {
    setDot(dotToken, "warn");
    txtToken.textContent = "Missing";
    btnLogin.style.display = "inline-block";
    btnLogout.style.display = "none";
    creatorRow.style.display = "none";
  }

  if(state.replies){
    setDot(dotReply, "ok");
    txtReply.textContent = "Running";
  } else {
    setDot(dotReply, "");
    txtReply.textContent = "Standby";
  }
}

async function checkMe(){
  try {
    const r = await fetch("/api/me", { cache: "no-store" });
    if(!r.ok) {
      state.authed = false;
      updateUI();
      return;
    }
    const me = await r.json();
    state.authed = true;

    creatorRow.style.display = "flex";
    creatorName.textContent = me.username || "Creator";
    creatorHandle.textContent = me.handle || "";
    creatorAvatar.src = me.avatar_url || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%234a4a6a' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/%3E%3C/svg%3E";

    updateUI();
  } catch (e) {
    state.authed = false;
    updateUI();
  }
}

function renderWebhook(evt){
  if(!evt){
    setDot(dotWebhook, "warn");
    txtWebhook.textContent = "Idle";
    wbSender.textContent = "â€”";
    wbHandle.textContent = "";
    wbMsg.textContent = "â€”";
    wbTime.textContent = "â€”";
    payloadBox.value = "// No webhook received yet";
    return;
  }

  setDot(dotWebhook, "ok");
  txtWebhook.textContent = "Live";

  const n = evt.normalized || {};
  wbSender.textContent = n.senderName || "Unknown";
  wbHandle.textContent = n.senderHandle || "";
  wbMsg.textContent = n.messageUuid || "â€”";
  wbTime.textContent = evt.receivedAt || "â€”";

  payloadBox.value = JSON.stringify(evt.body || evt, null, 2);
}

async function pollWebhooks(){
  if(!state.authed){
    renderWebhook(null);
    return;
  }

  try {
    const r = await fetch("/api/events/last", { cache: "no-store" });
    if(!r.ok){
      // if auth expired, /api/events/last returns 401
      renderWebhook(null);
      return;
    }
    const evt = await r.json();
    renderWebhook(evt);
  } catch (e){
    // keep last UI
  }
}

function startOAuth(){
  window.location.href = "/oauth/start";
}

async function logout(){
  try{
    await fetch("/api/logout", { method:"POST" });
    state.authed = false;
    renderWebhook(null);
    log("âœ… Logged out");
    updateUI();
  }catch(e){
    log("âŒ Logout failed");
  }
}

function enableAutoReply(){
  if(!state.authed){ log("âŒ Login first"); return; }
  state.replies = true;
  log("âœ… Auto-reply enabled (engine wiring next)");
  updateUI();
}

function killSwitch(){
  state.replies = false;
  log("ðŸš¨ Kill switch ON");
  updateUI();
}

function generateReply(){
  // For now: template-based (no OpenAI required). Weâ€™ll wire real Fanvue send next.
  const p = state.persona;
  const g = state.goal;

  const lines = [];

  if(p === "sweet") lines.push("Hey love ðŸ’—");
  if(p === "flirty") lines.push("Hey ðŸ˜ˆ");
  if(p === "dominant") lines.push("Hey. Come closer. ðŸ˜");

  if(g === "sub") lines.push("Subscribe so we can talk properly in here.");
  if(g === "tip") lines.push("If you want my attention right now, a tip gets priority.");
  if(g === "ppv") lines.push("Iâ€™ve got something exclusive for youâ€¦ want the unlock?");

  replyBox.value = lines.join("\n\n");
  log("âœ¨ Reply generated");
}

document.addEventListener("click", (e) => {
  const persona = e.target.getAttribute("data-persona");
  const goal = e.target.getAttribute("data-goal");
  if(persona){ state.persona = persona; log("Persona: " + persona); }
  if(goal){ state.goal = goal; log("Goal: " + goal); }
});

document.getElementById("btnRefresh").addEventListener("click", async () => {
  await checkMe();
  await pollWebhooks();
  log("ðŸ”„ Refreshed");
});

btnLogin.addEventListener("click", startOAuth);
btnLogout.addEventListener("click", logout);
document.getElementById("btnEnable").addEventListener("click", enableAutoReply);
document.getElementById("btnKill").addEventListener("click", killSwitch);
document.getElementById("btnGen").addEventListener("click", generateReply);

// Boot
(async function init(){
  await checkMe();
  await pollWebhooks();
  setInterval(checkMe, 6000);
  setInterval(pollWebhooks, 3000);
})();
</script>
</body>
</html>
